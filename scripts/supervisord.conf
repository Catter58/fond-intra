[supervisord]
nodaemon=true
user=root
logfile=/app/logs/supervisord.log
pidfile=/var/run/supervisord.pid
childlogdir=/app/logs

[program:postgresql]
command=/usr/lib/postgresql/14/bin/postgres -D /app/data/postgres
user=postgres
autostart=true
autorestart=true
priority=10
stdout_logfile=/app/logs/postgresql.log
stderr_logfile=/app/logs/postgresql-error.log

[program:redis]
command=/usr/bin/redis-server /etc/redis/redis.conf
user=redis
autostart=true
autorestart=true
priority=10
stdout_logfile=/app/logs/redis.log
stderr_logfile=/app/logs/redis-error.log

[program:django]
command=/usr/bin/python3 -m gunicorn --bind 127.0.0.1:8000 --workers 4 --timeout 120 config.wsgi:application
directory=/app/backend
user=appuser
autostart=true
autorestart=true
startsecs=10
priority=20
environment=DJANGO_SETTINGS_MODULE="config.settings.production",DATABASE_URL="postgres://%(ENV_POSTGRES_USER)s:%(ENV_POSTGRES_PASSWORD)s@localhost:5432/%(ENV_POSTGRES_DB)s",REDIS_URL="redis://localhost:6379/0",SECRET_KEY="%(ENV_SECRET_KEY)s",ALLOWED_HOSTS="%(ENV_ALLOWED_HOSTS)s",CORS_ALLOWED_ORIGINS="%(ENV_CORS_ALLOWED_ORIGINS)s",CORS_ALLOW_ALL="%(ENV_CORS_ALLOW_ALL)s",FRONTEND_URL="%(ENV_FRONTEND_URL)s"
stdout_logfile=/app/logs/django.log
stderr_logfile=/app/logs/django-error.log

[program:celery]
command=/usr/bin/python3 -m celery -A config worker -l info
directory=/app/backend
user=appuser
autostart=true
autorestart=true
startsecs=10
priority=30
environment=DJANGO_SETTINGS_MODULE="config.settings.production",DATABASE_URL="postgres://%(ENV_POSTGRES_USER)s:%(ENV_POSTGRES_PASSWORD)s@localhost:5432/%(ENV_POSTGRES_DB)s",REDIS_URL="redis://localhost:6379/0",SECRET_KEY="%(ENV_SECRET_KEY)s"
stdout_logfile=/app/logs/celery.log
stderr_logfile=/app/logs/celery-error.log

[program:celery-beat]
command=/usr/bin/python3 -m celery -A config beat -l info --scheduler django_celery_beat.schedulers:DatabaseScheduler
directory=/app/backend
user=appuser
autostart=true
autorestart=true
startsecs=10
priority=30
environment=DJANGO_SETTINGS_MODULE="config.settings.production",DATABASE_URL="postgres://%(ENV_POSTGRES_USER)s:%(ENV_POSTGRES_PASSWORD)s@localhost:5432/%(ENV_POSTGRES_DB)s",REDIS_URL="redis://localhost:6379/0",SECRET_KEY="%(ENV_SECRET_KEY)s"
stdout_logfile=/app/logs/celery-beat.log
stderr_logfile=/app/logs/celery-beat-error.log

[program:nginx]
command=/usr/sbin/nginx -g "daemon off;"
autostart=true
autorestart=true
priority=40
stdout_logfile=/app/logs/nginx.log
stderr_logfile=/app/logs/nginx-error.log

[program:cron]
command=/usr/sbin/cron -f
autostart=true
autorestart=true
priority=50
stdout_logfile=/app/logs/cron.log
stderr_logfile=/app/logs/cron-error.log
